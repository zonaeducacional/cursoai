<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CACO - Comunidade Aberta de Cursos Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos adicionais para transições suaves e compatibilidade */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 shadow-md py-4 px-6 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center space-x-2">
            <i class="fas fa-graduation-cap text-primary-600 dark:text-primary-400 text-2xl"></i>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white">CACO</h1>
        </div>
        <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300">
                <i id="theme-icon-moon" class="fas fa-moon"></i>
                <i id="theme-icon-sun" class="fas fa-sun hidden"></i>
            </button>
            <div id="user-info" class="hidden items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold">
                    <span id="user-initial"></span>
                </div>
                <span id="username" class="text-gray-700 dark:text-gray-300"></span>
                <button id="logout-btn" class="ml-2 text-red-500 hover:text-red-700" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            <button id="login-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center transition-all">
                <i class="fas fa-sign-in-alt mr-2"></i>Entrar
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Home Page -->
        <div id="home-page">
            <!-- Hero Section -->
            <div class="bg-gradient-to-r from-primary-500 to-primary-700 rounded-xl p-8 mb-12 text-white text-center">
                <h1 class="text-4xl font-bold mb-4">Bem-vindo à Nossa Comunidade Aberta de Cursos Online</h1>
                <p class="text-xl text-primary-100 max-w-3xl mx-auto">Aprenda, Medie, Compartilhe.</p>
            </div>

            <!-- Courses Section -->
            <div class="mb-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Nossos Cursos</h2>
                    <button id="add-course-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center hidden">
                        <i class="fas fa-plus mr-2"></i>Adicionar Curso
                    </button>
                </div>
                <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Courses will be loaded here -->
                </div>
            </div>

            <!-- Features Section -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">Por que escolher nossos cursos?</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-6">
                        <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-graduation-cap text-primary-600 dark:text-primary-400 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Conteúdo de Qualidade</h3>
                        <p class="text-gray-600 dark:text-gray-400">Aulas elaboradas por especialistas na área para garantir o máximo de aprendizado.</p>
                    </div>
                    <div class="text-center p-6">
                        <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-clock text-primary-600 dark:text-primary-400 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Acesso Vitalício</h3>
                        <p class="text-gray-600 dark:text-gray-400">Compre uma vez e tenha acesso ao conteúdo para sempre, sem mensalidades.</p>
                    </div>
                    <div class="text-center p-6">
                        <div class="w-16 h-16 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-certificate text-primary-600 dark:text-primary-400 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Certificado de Conclusão</h3>
                        <p class="text-gray-600 dark:text-gray-400">Receba um certificado reconhecido ao finalizar seus cursos.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-lg p-8 w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Login</h2>
                    <button id="close-login" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="login-username">Usuário</label>
                        <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="login-password">Senha</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg transition duration-300">Entrar</button>
                    <div id="login-error" class="mt-4 text-red-500 text-center hidden">Usuário ou senha incorretos!</div>
                </form>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            <!-- Welcome Section -->
            <div class="bg-gradient-to-r from-primary-500 to-primary-700 rounded-xl p-8 mb-8 text-white">
                <h2 class="text-3xl font-bold mb-2">Bem-vindo, <span id="user-name-display"></span>!</h2>
                <p class="text-primary-100">Aprenda com os melhores conteúdos e materiais educacionais.</p>
            </div>

            <!-- Course Modules -->
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Meus Cursos</h3>
                <div id="user-courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User courses will be loaded here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Atividade Recente</h3>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6">
                    <div class="space-y-4">
                        <div class="flex items-center p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
                            <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mr-4">
                                <i class="fas fa-video text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">Aula 1: Introdução ao Curso</h4>
                                <p class="text-gray-600 dark:text-gray-400 text-sm">Assistido há 2 dias</p>
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
                            <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mr-4">
                                <i class="fas fa-file-pdf text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">Material de Apoio - Módulo 1</h4>
                                <p class="text-gray-600 dark:text-gray-400 text-sm">Baixado há 3 dias</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="hidden">
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Painel Administrativo</h2>
                <div class="flex space-x-4 mb-6 border-b border-gray-200 dark:border-slate-700">
                    <button id="students-tab" class="px-4 py-2 border-b-2 border-primary-600 text-primary-600">Alunos</button>
                    <button id="content-tab" class="px-4 py-2 border-b-2 border-transparent text-gray-500 dark:text-gray-400">Conteúdo</button>
                    <button id="courses-tab" class="px-4 py-2 border-b-2 border-transparent text-gray-500 dark:text-gray-400">Cursos</button>
                </div>

                <!-- Students Section -->
                <div id="students-section">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Gerenciar Alunos</h3>
                        <button id="add-student-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i>Adicionar Aluno
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-slate-700 rounded-lg">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-slate-600">
                                    <th class="py-3 px-4 text-left text-gray-700 dark:text-gray-300">Nome</th>
                                    <th class="py-3 px-4 text-left text-gray-700 dark:text-gray-300">Email</th>
                                    <th class="py-3 px-4 text-left text-gray-700 dark:text-gray-300">Status</th>
                                    <th class="py-3 px-4 text-left text-gray-700 dark:text-gray-300">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Content Section -->
                <div id="content-section" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Gerenciar Conteúdo</h3>
                        <button id="add-content-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i>Adicionar Conteúdo
                        </button>
                    </div>
                    <div id="content-list" class="space-y-4">
                        <!-- Content items will be loaded here -->
                    </div>
                </div>

                <!-- Courses Section -->
                <div id="courses-section" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Gerenciar Cursos</h3>
                        <button id="add-course-admin-btn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i>Adicionar Curso
                        </button>
                    </div>
                    <div id="admin-courses-list" class="space-y-4">
                        <!-- Courses will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALS (Student, Content, Course) -->
        <!-- Add/Edit Student Modal -->
        <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-lg p-8 w-full max-w-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="student-modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">Adicionar Aluno</h2>
                    <button id="close-student-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="student-form">
                    <input type="hidden" id="student-id" name="id">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="student-name">Nome</label>
                        <input type="text" id="student-name" name="name" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="student-email">Email</label>
                        <input type="email" id="student-email" name="email" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="student-username">Nome de Usuário</label>
                        <input type="text" id="student-username" name="username" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="student-password">Senha</label>
                        <input type="password" id="student-password" name="password" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg transition duration-300">Salvar Aluno</button>
                </form>
            </div>
        </div>

        <!-- Add/Edit Content Modal -->
        <div id="content-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-lg p-8 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="content-modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">Adicionar Conteúdo</h2>
                    <button id="close-content-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="content-form">
                    <input type="hidden" id="content-id" name="id">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="content-title">Título</label>
                        <input type="text" id="content-title" name="title" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="content-type">Tipo de Conteúdo</label>
                        <select id="content-type" name="type" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white">
                            <option value="video">Vídeo</option>
                            <option value="audio">Áudio</option>
                            <option value="pdf">PDF</option>
                            <option value="docx">Documento (DOCX)</option>
                            <option value="image">Imagem</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="content-url">URL do Conteúdo</label>
                        <input type="url" id="content-url" name="url" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" placeholder="https://exemplo.com/conteudo" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="content-description">Descrição</label>
                        <textarea id="content-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg transition duration-300">Salvar Conteúdo</button>
                </form>
            </div>
        </div>

        <!-- Add/Edit Course Modal -->
        <div id="course-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-lg p-8 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="course-modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">Adicionar Curso</h2>
                    <button id="close-course-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="course-form">
                    <input type="hidden" id="course-id" name="id">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="course-title">Título do Curso</label>
                        <input type="text" id="course-title" name="title" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="course-image">URL da Imagem</label>
                        <input type="url" id="course-image" name="image" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" placeholder="https://exemplo.com/imagem.jpg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="course-description">Descrição</label>
                        <textarea id="course-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="course-duration">Duração (horas)</label>
                        <input type="number" id="course-duration" name="duration" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2" for="course-price">Preço (R$)</label>
                        <input type="number" id="course-price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white" required>
                    </div>
                    <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg transition duration-300">Salvar Curso</button>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                <div class="flex items-center space-x-2 mb-4 md:mb-0">
                    <i class="fas fa-graduation-cap text-primary-600 dark:text-primary-400 text-2xl"></i>
                    <span class="text-lg font-semibold text-gray-800 dark:text-white">CACO</span>
                </div>
                <div class="text-gray-600 dark:text-gray-400 text-sm mb-4 md:mb-0">
                    &copy; 2024 CACO. Todos os direitos reservados.
                </div>
                <div class="flex space-x-6 justify-center">
                    <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400">
                        <i class="fab fa-instagram"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let appData = {};
            let currentUser = null;

            // --- CONSTANTS ---
            const BIN_ID = '68d0654343b1c97be94ab935';
            const API_KEY = '$2a$10$R2BGtzfNrVQDNBk5q9crX.Kfm0FtiVW/EgjUTpqweX7mAnHbMEvZ.';
            const DEFAULT_DATA = {
                students: [
                    { id: 1, name: "Maria Silva", email: "maria@email.com", username: "maria123", password: "senha123", status: "Ativo" },
                    { id: 2, name: "João Santos", email: "joao@email.com", username: "joao456", password: "senha456", status: "Ativo" }
                ],
                content: [
                    { id: 1, title: "Introdução ao Curso", type: "video", url: "https://www.youtube.com/embed/dQw4w9WgXcQ", description: "Vídeo de introdução ao curso online" }
                ],
                courses: [
                    { id: 1, title: "Curso Completo de Programação", image: "https://placehold.co/600x400/0ea5e9/white?text=Programação", description: "Aprenda programação do zero com este curso completo.", duration: 40, price: 299.90, contentIds: [1] }
                ],
                admins: [
                    { username: "sergio", password: "j1junior" }
                ]
            };

            // --- DOM ELEMENT SELECTORS ---
            const DOMElements = {
                loginBtn: document.getElementById('login-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                loginModal: document.getElementById('login-modal'),
                closeLogin: document.getElementById('close-login'),
                loginForm: document.getElementById('login-form'),
                loginError: document.getElementById('login-error'),
                dashboard: document.getElementById('dashboard'),
                adminPanel: document.getElementById('admin-panel'),
                userInfo: document.getElementById('user-info'),
                usernameSpan: document.getElementById('username'),
                userNameDisplay: document.getElementById('user-name-display'),
                userInitial: document.getElementById('user-initial'),
                themeToggle: document.getElementById('theme-toggle'),
                themeIconMoon: document.getElementById('theme-icon-moon'),
                themeIconSun: document.getElementById('theme-icon-sun'),
                homePage: document.getElementById('home-page'),
                coursesContainer: document.getElementById('courses-container'),
                userCoursesContainer: document.getElementById('user-courses-container'),
                adminTabs: {
                    students: document.getElementById('students-tab'),
                    content: document.getElementById('content-tab'),
                    courses: document.getElementById('courses-tab'),
                },
                adminSections: {
                    students: document.getElementById('students-section'),
                    content: document.getElementById('content-section'),
                    courses: document.getElementById('courses-section'),
                },
                modals: {
                    student: document.getElementById('student-modal'),
                    content: document.getElementById('content-modal'),
                    course: document.getElementById('course-modal'),
                },
                forms: {
                    student: document.getElementById('student-form'),
                    content: document.getElementById('content-form'),
                    course: document.getElementById('course-form'),
                },
                addButtons: {
                    student: document.getElementById('add-student-btn'),
                    content: document.getElementById('add-content-btn'),
                    course: document.getElementById('add-course-btn'),
                    courseAdmin: document.getElementById('add-course-admin-btn'),
                },
                closeModalButtons: {
                    student: document.getElementById('close-student-modal'),
                    content: document.getElementById('close-content-modal'),
                    course: document.getElementById('close-course-modal'),
                },
                adminLists: {
                    students: document.getElementById('students-table-body'),
                    content: document.getElementById('content-list'),
                    courses: document.getElementById('admin-courses-list'),
                },
            };

            // --- DATA HANDLING ---
            const loadData = async () => {
                try {
                    console.log('Carregando dados...');
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        method: 'GET',
                        headers: { 'X-Master-Key': API_KEY }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const record = data.record || {};
                        console.log('Dados carregados:', record);
                        
                        // Ensure all top-level keys are initialized as arrays if they don't exist in the record
                        appData = {
                            students: Array.isArray(record.students) ? record.students : DEFAULT_DATA.students,
                            content: Array.isArray(record.content) ? record.content : DEFAULT_DATA.content,
                            courses: Array.isArray(record.courses) ? record.courses : DEFAULT_DATA.courses,
                            admins: Array.isArray(record.admins) ? record.admins : DEFAULT_DATA.admins,
                        };
                    } else {
                        console.warn('Could not fetch data from JSONBin. Using default data.');
                        appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); // Deep copy
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); // Deep copy
                }
            };

            const saveData = async () => {
                try {
                    console.log('Salvando dados:', appData);
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify(appData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Dados salvos com sucesso:', result);
                        return true;
                    } else {
                        console.error('Failed to save data to JSONBin. Status:', response.status);
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        return false;
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            };

            // --- UI & THEME ---
            const toggleTheme = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                updateThemeIcons(isDark);
            };

            const updateThemeIcons = (isDark) => {
                DOMElements.themeIconMoon.classList.toggle('hidden', isDark);
                DOMElements.themeIconSun.classList.toggle('hidden', !isDark);
            };

            const initTheme = () => {
                const isDark = localStorage.getItem('darkMode') === 'true';
                if (isDark) {
                    document.documentElement.classList.add('dark');
                }
                updateThemeIcons(isDark);
            };

            // --- PAGE/VIEW MANAGEMENT ---
            const showPage = (pageId) => {
                ['home-page', 'dashboard', 'admin-panel'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(pageId).classList.remove('hidden');
            };

            // --- AUTHENTICATION ---
            const handleLogin = (e) => {
                e.preventDefault();
                const username = DOMElements.loginForm.elements['login-username'].value;
                const password = DOMElements.loginForm.elements['login-password'].value;

                const admin = appData.admins.find(a => a.username === username && a.password === password);
                if (admin) {
                    currentUser = { username: admin.username, role: 'admin' };
                    loginSuccess();
                    showPage('admin-panel');
                    renderAdminPanel();
                    return;
                }

                const student = appData.students.find(s => s.username === username && s.password === password);
                if (student) {
                    currentUser = { ...student, role: 'student' };
                    loginSuccess();
                    showPage('dashboard');
                    renderDashboard();
                    return;
                }

                DOMElements.loginError.classList.remove('hidden');
                setTimeout(() => DOMElements.loginError.classList.add('hidden'), 3000);
            };

            const loginSuccess = () => {
                DOMElements.loginModal.classList.add('hidden');
                DOMElements.loginBtn.classList.add('hidden');
                DOMElements.userInfo.classList.remove('hidden');
                DOMElements.userInfo.classList.add('flex');

                const name = currentUser.name || currentUser.username;
                DOMElements.usernameSpan.textContent = name;
                DOMElements.userNameDisplay.textContent = name;
                DOMElements.userInitial.textContent = name.charAt(0).toUpperCase();

                // Show/hide admin-specific buttons
                DOMElements.addButtons.course.classList.toggle('hidden', currentUser.role !== 'admin');
            };

            const logout = () => {
                currentUser = null;
                DOMElements.userInfo.classList.add('hidden');
                DOMElements.userInfo.classList.remove('flex');
                DOMElements.loginBtn.classList.remove('hidden');
                DOMElements.addButtons.course.classList.add('hidden'); // Hide on logout
                showPage('home-page');
                DOMElements.loginForm.reset();
            };

            // --- RENDERING FUNCTIONS ---
            const renderHomePageCourses = () => {
                DOMElements.coursesContainer.innerHTML = '';
                if (!appData.courses || !Array.isArray(appData.courses)) return;

                appData.courses.forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.className = 'bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300';
                    courseCard.innerHTML = `
                        <img src="${course.image}" alt="${course.title}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-gray-800 dark:text-white mb-2">${course.title}</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-4 h-20 overflow-hidden">${course.description}</p>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-primary-600 dark:text-primary-400 font-semibold">R$ ${Number(course.price).toFixed(2)}</span>
                                <span class="text-gray-500 dark:text-gray-400">${course.duration} horas</span>
                            </div>
                            <button class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg transition duration-300">Saiba Mais</button>
                        </div>
                    `;
                    DOMElements.coursesContainer.appendChild(courseCard);
                });
            };

            const renderDashboard = () => {
                DOMElements.userCoursesContainer.innerHTML = '';
                if (!appData.courses || !Array.isArray(appData.courses)) return;

                appData.courses.forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.className = 'bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden';
                    courseCard.innerHTML = `
                        <img src="${course.image}" alt="${course.title}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-gray-800 dark:text-white mb-2">${course.title}</h3>
                            <div class="h-1 bg-gray-200 dark:bg-slate-700 rounded-full mt-4 mb-2">
                                <div class="h-1 bg-primary-500 rounded-full" style="width: 25%;"></div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">25% concluído</p>
                            <button class="w-full bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-lg">Continuar Curso</button>
                        </div>
                    `;
                    DOMElements.userCoursesContainer.appendChild(courseCard);
                });
            };

            const renderAdminPanel = () => {
                renderStudents();
                renderContent();
                renderAdminCourses();
            };

            const renderStudents = () => {
                DOMElements.adminLists.students.innerHTML = '';
                if (!appData.students || !Array.isArray(appData.students)) return;

                appData.students.forEach(student => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 dark:border-slate-600';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-800 dark:text-white">${student.name}</td>
                        <td class="py-3 px-4 text-gray-600 dark:text-gray-400">${student.email}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded-full text-xs ${student.status === 'Ativo' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">${student.status}</span>
                        </td>
                        <td class="py-3 px-4">
                            <button data-action="edit" data-type="student" data-id="${student.id}" class="text-blue-500 hover:text-blue-700 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button data-action="delete" data-type="student" data-id="${student.id}" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    DOMElements.adminLists.students.appendChild(row);
                });
            };

            const renderContent = () => {
                DOMElements.adminLists.content.innerHTML = '';
                if (!appData.content || !Array.isArray(appData.content)) return;

                appData.content.forEach(item => {
                    const contentItem = document.createElement('div');
                    contentItem.className = 'bg-gray-50 dark:bg-slate-700 rounded-lg p-4 flex justify-between items-center';
                    
                    let iconClass = '';
                    switch(item.type) {
                        case 'video': iconClass = 'fas fa-video text-red-500'; break;
                        case 'audio': iconClass = 'fas fa-headphones text-green-500'; break;
                        case 'pdf': iconClass = 'fas fa-file-pdf text-red-600'; break;
                        case 'docx': iconClass = 'fas fa-file-word text-blue-500'; break;
                        case 'image': iconClass = 'fas fa-image text-purple-500'; break;
                        default: iconClass = 'fas fa-file';
                    }

                    contentItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center mr-4">
                                <i class="${iconClass}"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">${item.title}</h4>
                                <p class="text-gray-600 dark:text-gray-400 text-sm">${item.type}</p>
                            </div>
                        </div>
                        <div>
                            <button data-action="edit" data-type="content" data-id="${item.id}" class="text-blue-500 hover:text-blue-700 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button data-action="delete" data-type="content" data-id="${item.id}" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    DOMElements.adminLists.content.appendChild(contentItem);
                });
            };

            const renderAdminCourses = () => {
                DOMElements.adminLists.courses.innerHTML = '';
                if (!appData.courses || !Array.isArray(appData.courses)) return;

                appData.courses.forEach(course => {
                    const courseItem = document.createElement('div');
                    courseItem.className = 'bg-gray-50 dark:bg-slate-700 rounded-lg p-4 flex justify-between items-center';
                    courseItem.innerHTML = `
                        <div class="flex items-center">
                            <img src="${course.image}" alt="${course.title}" class="w-16 h-10 object-cover rounded-lg mr-4">
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">${course.title}</h4>
                                <p class="text-gray-600 dark:text-gray-400 text-sm">R$ ${Number(course.price).toFixed(2)}</p>
                            </div>
                        </div>
                        <div>
                            <button data-action="edit" data-type="course" data-id="${course.id}" class="text-blue-500 hover:text-blue-700 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button data-action="delete" data-type="course" data-id="${course.id}" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    DOMElements.adminLists.courses.appendChild(courseItem);
                });
            };

            // --- MODAL & FORM HANDLING ---
            const openModal = (modalName, id = null) => {
                const modal = DOMElements.modals[modalName];
                const form = DOMElements.forms[modalName];
                form.reset();

                const dataMap = { student: 'students', content: 'content', course: 'courses' };
                const dataKey = dataMap[modalName];
                const titleElement = document.getElementById(`${modalName}-modal-title`);
                const idInput = form.elements['id'];
                
                idInput.value = '';

                if (id) {
                    titleElement.textContent = `Editar ${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`;
                    const item = appData[dataKey].find(i => i.id == id);
                    if (item) {
                        for (const key in item) {
                            if (form.elements[key]) {
                                form.elements[key].value = item[key];
                            }
                        }
                    }
                } else {
                    titleElement.textContent = `Adicionar ${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`;
                }

                modal.classList.remove('hidden');
            };

            const closeModal = (modalName) => {
                DOMElements.modals[modalName].classList.add('hidden');
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const modalName = form.id.split('-')[0];
                const dataMap = { student: 'students', content: 'content', course: 'courses' };
                const dataKey = dataMap[modalName];
                const dataArray = appData[dataKey];

                const formData = new FormData(form);
                const formEntry = Object.fromEntries(formData.entries());

                // Convert numeric fields from string, regardless of add or edit
                if(formEntry.price) formEntry.price = parseFloat(formEntry.price);
                if(formEntry.duration) formEntry.duration = parseInt(formEntry.duration, 10);

                if (formEntry.id) { // Edit
                    const index = dataArray.findIndex(item => item.id == formEntry.id);
                    if (index > -1) {
                        // Ensure ID remains a number
                        formEntry.id = parseInt(formEntry.id, 10);
                        // Preserve contentIds when editing a course
                        const existingContentIds = dataArray[index].contentIds || [];
                        dataArray[index] = { ...dataArray[index], ...formEntry, contentIds: existingContentIds };
                    }
                } else { // Add
                    const newId = dataArray.length > 0 ? Math.max(...dataArray.map(item => item.id)) + 1 : 1;
                    formEntry.id = newId;
                    
                    if (modalName === 'student') formEntry.status = 'Ativo';
                    // Initialize contentIds for new courses
                    if (modalName === 'course') formEntry.contentIds = [];
                    
                    dataArray.push(formEntry);
                }

                console.log('Dados antes de salvar:', appData);
                const saveSuccess = await saveData();
                
                if (saveSuccess) {
                    console.log('Salvamento bem-sucedido');
                    closeModal(modalName);
                    renderAdminPanel();
                    renderHomePageCourses(); // Also update home page courses
                } else {
                    console.error('Falha no salvamento');
                    alert('Erro ao salvar. Tente novamente.');
                }
            };

            // --- EVENT LISTENERS ---
            const setupEventListeners = () => {
                DOMElements.loginBtn.addEventListener('click', () => DOMElements.loginModal.classList.remove('hidden'));
                DOMElements.closeLogin.addEventListener('click', () => DOMElements.loginModal.classList.add('hidden'));
                DOMElements.logoutBtn.addEventListener('click', logout);
                DOMElements.loginForm.addEventListener('submit', handleLogin);
                DOMElements.themeToggle.addEventListener('click', toggleTheme);

                // Admin Tabs
                Object.keys(DOMElements.adminTabs).forEach(key => {
                    DOMElements.adminTabs[key].addEventListener('click', () => {
                        Object.values(DOMElements.adminSections).forEach(section => section.classList.add('hidden'));
                        DOMElements.adminSections[key].classList.remove('hidden');

                        Object.values(DOMElements.adminTabs).forEach(tab => {
                            tab.classList.remove('border-primary-600', 'text-primary-600');
                            tab.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                        });

                        DOMElements.adminTabs[key].classList.add('border-primary-600', 'text-primary-600');
                        DOMElements.adminTabs[key].classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    });
                });

                // Add buttons
                DOMElements.addButtons.student.addEventListener('click', () => openModal('student'));
                DOMElements.addButtons.content.addEventListener('click', () => openModal('content'));
                DOMElements.addButtons.course.addEventListener('click', () => openModal('course'));
                DOMElements.addButtons.courseAdmin.addEventListener('click', () => openModal('course'));

                // Close modal buttons
                Object.keys(DOMElements.closeModalButtons).forEach(key => {
                    DOMElements.closeModalButtons[key].addEventListener('click', () => closeModal(key));
                });

                // Form submissions
                Object.values(DOMElements.forms).forEach(form => {
                    form.addEventListener('submit', handleFormSubmit);
                });

                // Edit/Delete buttons (event delegation)
                DOMElements.adminPanel.addEventListener('click', async (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;

                    const { action, type, id } = button.dataset;

                    if (action === 'edit') {
                        openModal(type, id);
                    } else if (action === 'delete') {
                        if (confirm('Tem certeza que deseja excluir este item?')) {
                            const dataMap = { student: 'students', content: 'content', course: 'courses' };
                            const dataKey = dataMap[type];
                            appData[dataKey] = appData[dataKey].filter(item => item.id != id);
                            
                            const saveSuccess = await saveData();
                            if (saveSuccess) {
                                renderAdminPanel();
                                renderHomePageCourses();
                            } else {
                                alert('Erro ao excluir. Tente novamente.');
                            }
                        }
                    }
                });

                // Close modal on outside click
                window.addEventListener('click', (e) => {
                    if (e.target === DOMElements.loginModal) DOMElements.loginModal.classList.add('hidden');
                    if (e.target === DOMElements.modals.student) closeModal('student');
                    if (e.target === DOMElements.modals.content) closeModal('content');
                    if (e.target === DOMElements.modals.course) closeModal('course');
                });
            };

            // --- INITIALIZATION ---
            const initApp = async () => {
                initTheme();
                await loadData();
                renderHomePageCourses();
                setupEventListeners();
                showPage('home-page');
            };

            initApp();
        });
    </script>
</body>
</html>
